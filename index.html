<!DOCTYPE html>
<html lang="ht">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes, viewport-fit=cover">
    
    <title>D'H7 | Digital Hub 7</title>
    <meta name="description" content="D'H7 (Digital Hub 7) se yon platfòm kominikasyon sekirize ki pèmèt ou jere idantite dijital ou ak yon TFID/D'H7 inik. Konekte kounye a pou w jwenn aksè nan yon rezo pwoteje, miltiling (Kreyòl, Fransè, Angle, Espanyòl), epi fasil pou itilize.">

    <link rel="icon" type="image/png" href="https://www.adamdh7.org/asset/IMG_7023.png">
    <link rel="shortcut icon" href="https://www.adamdh7.org/asset/IMG_7023.png">
    <link rel="canonical" href="https://www.adamdh7.org/" />
    <link rel="apple-touch-icon" href="https://www.adamdh7.org/asset/IMG_7023.png" />

    <meta property="og:title" content="D'H7 - Digital Hub 7">
    <meta property="og:description" content="Konekte sou D'H7 pou yon eksperyans dijital sekirize.">
    <meta property="og:image" content="https://www.adamdh7.org/asset/IMG_7023.png">
    <meta property="og:url" content="https://www.adamdh7.org">
    <meta property="og:type" content="website">

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "D'H7",
      "alternateName": "Digital Hub 7",
      "url": "https://www.adamdh7.org",
      "logo": "https://www.adamdh7.org/asset/IMG_7023.png"
    }
    </script>

    <link rel="manifest" href="manifest.json" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        :root {
            --bg-pure: #000000;
            --bg-card: #0a0a0a;
            --bg-input: #1c1c1e;
            --accent: #007aff;
            --border: #1a1a1a;
            --text-dim: #8e8e93;
            --msg-me: #007aff;
            --msg-them: #262628;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-pure);
            color: white;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            position: fixed;
            inset: 0;
        }

        .scroll-container {
            overflow-y: auto;
            overflow-x: hidden;
            touch-action: pan-y;
            overscroll-behavior-y: contain;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            flex: 1;
            min-height: 0;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .scroll-container::-webkit-scrollbar { 
            display: none; 
            width: 0 !important; 
        }

        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-pure);
            z-index: 10;
            transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1), opacity 0.2s;
        }

        .screen.hidden-left { transform: translateX(-30%); opacity: 0; pointer-events: none; }
        .screen.hidden-right { transform: translateX(100%); opacity: 1; pointer-events: none; }
        .screen.active { transform: translateX(0); opacity: 1; pointer-events: auto; }

        /* Header toujours visible (fixed) */
        .ios-header {
            position: fixed;
            top: env(safe-area-inset-top);
            left: 0;
            right: 0;
            padding: 1rem;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 20;
            border-bottom: 0.5px solid rgba(255,255,255,0.1);
        }

        /* Chat body avec padding pour le header fixed */
        .chat-body {
            flex: 1;
            padding: 1rem;
            padding-top: var(--header-height, 90px);
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .bubble {
            max-width: 85%;
            padding: 0.5rem 0.8rem;
            font-size: 1rem;
            line-height: 1.4;
            position: relative;
            white-space: pre-wrap;
            word-break: break-word;
            margin-bottom: 2px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }

        .bubble.me {
            align-self: flex-end;
            background-color: var(--msg-me);
            color: white;
            border-radius: 12px 12px 0 12px;
        }

        .bubble.them {
            align-self: flex-start;
            background-color: var(--msg-them);
            color: white;
            border-radius: 12px 12px 12px 0;
        }

        /* Media */
        .media-content {
            border-radius: 8px;
            overflow: hidden;
            margin: 4px 0;
            cursor: pointer;
        }
        .media-content img, .media-content video {
            max-width: 100%;
            height: auto;
            display: block;
        }

        .fullscreen-media {
            position: fixed;
            inset: 0;
            background: black;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            overflow: auto;
        }
        .fullscreen-media img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            touch-action: pinch-zoom pan-y;
        }
        .fullscreen-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            cursor: pointer;
            z-index: 10000;
        }

        /* Reply preview toujours au-dessus de la barre d'envoi */
        .input-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 0.5rem 0.5rem calc(0.5rem + env(safe-area-inset-bottom));
            background: var(--bg-pure);
            border-top: 0.5px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            z-index: 15;
            transition: transform 0.3s ease;
        }

        #reply-preview {
            width: calc(100% - 1rem);
            margin: 0 auto 0.5rem auto;
            background: #262628;
            padding: 0.5rem;
            border-radius: 12px;
            border-left: 4px solid var(--accent);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }

        .input-bottom-row {
            width: 100%;
            display: flex;
            align-items: flex-end;
            gap: 0.5rem;
        }

        .input-wrapper {
            flex: 1;
            background: var(--bg-input);
            border-radius: 20px;
            display: flex;
            align-items: flex-end;
            padding: 8px 12px;
            min-height: 40px;
        }

        /* Voice player copié depuis la version fonctionnelle */
        .voice-player {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0;
            width: auto;
            max-width: 250px;
        }
        .play-pause {
            cursor: pointer;
            width: 20px;
            height: 20px;
        }
        .progress-bar {
            flex: 1;
            height: 4px;
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .wave-form {
            position: absolute;
            height: 100%;
            width: 100%;
            display: flex;
            gap: 1px;
        }
        .wave-bar {
            width: 2px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
        }
        .bubble.me .wave-bar {
            background: rgba(255,255,255,0.8);
        }
        .bubble.them .wave-bar.progressed {
            background: var(--accent);
        }
        .bubble.me .wave-bar.progressed {
            background: white;
        }
        .seeker {
            position: absolute;
            top: -4px;
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            transform: translateX(-50%);
        }
        .time-display {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.7);
            min-width: 30px;
            display: block;
        }
        .speed-control {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            margin-left: 4px;
        }

        .status {
            font-size: 0.65rem;
            color: rgba(255,255,255,0.6);
            float: right;
            margin-left: 8px;
            margin-top: 4px;
        }
        .status.read { color: #66e0ff; }

        .action-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--msg-me);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
            transition: all 0.2s;
            cursor: pointer;
        }
        .action-btn.mic-mode { background: var(--msg-them); }

        #upload-loading {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            color: white;
            font-size: 1.2rem;
        }

        .see-more {
            color: var(--accent);
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 4px;
            display: block;
        }
    </style>
</head>
<body>

    <!-- HTML identique à votre première version (je ne le répète pas pour brevité, mais il reste inchangé) -->
    <!-- ... tout le HTML des screens ... -->

    <script>
        // ... tout le code JS de votre première version jusqu'à renderText ...

        // === VOICE PLAYER COPIÉ DE LA VERSION FONCTIONNELLE ===
        function renderCustomVoicePlayer(src) {
            const playerId = `${crypto.randomUUID()}`;
            return `
                <div class="voice-player" data-src="${src}" id="${playerId}">
                    <svg class="play-pause" viewBox="0 0 24 24" fill="white">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    <div class="progress-bar">
                        <div class="wave-form"></div>
                        <div class="seeker" style="left: 0%;"></div>
                    </div>
                    <span class="time-display">0:00</span>
                    <span class="speed-control">1x</span>
                </div>
            `;
        }

        function attachVoicePlayers() {
            document.querySelectorAll('.voice-player:not(.attached)').forEach(player => {
                player.classList.add('attached');
                const audio = new Audio(player.dataset.src);
                const playPause = player.querySelector('.play-pause');
                const progressBar = player.querySelector('.progress-bar');
                const waveForm = player.querySelector('.wave-form');
                const seeker = player.querySelector('.seeker');
                const timeDisplay = player.querySelector('.time-display');
                const speedControl = player.querySelector('.speed-control');
                let isPlaying = false;
                let isSeeking = false;
                let speeds = ['1x', '1.5x', '2x'];
                let currentSpeedIndex = 0;
                audio.playbackRate = 1;

                // 50 barres comme dans la version fonctionnelle
                for (let i = 0; i < 50; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'wave-bar';
                    bar.style.height = `${Math.random() * 80 + 20}%`;
                    waveForm.appendChild(bar);
                }
                const waveBars = waveForm.querySelectorAll('.wave-bar');

                speedControl.addEventListener('click', () => {
                    currentSpeedIndex = (currentSpeedIndex + 1) % speeds.length;
                    speedControl.textContent = speeds[currentSpeedIndex];
                    audio.playbackRate = parseFloat(speeds[currentSpeedIndex]);
                });

                playPause.addEventListener('click', () => {
                    if (isPlaying) {
                        audio.pause();
                        playPause.innerHTML = '<path d="M8 5v14l11-7z"/>';
                    } else {
                        audio.play();
                        playPause.innerHTML = '<path d="M6 4h4v16H6zM14 4h4v16h-4z"/>';
                    }
                    isPlaying = !isPlaying;
                });

                audio.addEventListener('timeupdate', () => {
                    if (!isSeeking) {
                        const progress = (audio.currentTime / audio.duration) * 100;
                        seeker.style.left = `${progress}%`;
                        timeDisplay.textContent = formatTime(audio.currentTime);
                        updateWaveProgress(progress);
                    }
                });

                audio.addEventListener('loadedmetadata', () => {
                    timeDisplay.textContent = formatTime(audio.duration);
                });

                audio.addEventListener('ended', () => {
                    isPlaying = false;
                    playPause.innerHTML = '<path d="M8 5v14l11-7z"/>';
                    seeker.style.left = '0%';
                    timeDisplay.textContent = formatTime(audio.duration);
                    updateWaveProgress(0);
                });

                progressBar.addEventListener('touchstart', startSeek, { passive: false });
                progressBar.addEventListener('mousedown', startSeek);

                function startSeek(e) {
                    isSeeking = true;
                    seek(e);
                    document.addEventListener('touchmove', seek, { passive: false });
                    document.addEventListener('mousemove', seek);
                    document.addEventListener('touchend', endSeek);
                    document.addEventListener('mouseup', endSeek);
                }

                function seek(e) {
                    const touch = e.touches ? e.touches[0] : e;
                    const rect = progressBar.getBoundingClientRect();
                    let x = touch.clientX - rect.left;
                    x = Math.max(0, Math.min(x, rect.width));
                    const progress = (x / rect.width) * 100;
                    seeker.style.left = `${progress}%`;
                    audio.currentTime = (progress / 100) * audio.duration;
                    updateWaveProgress(progress);
                }

                function endSeek() {
                    isSeeking = false;
                    document.removeEventListener('touchmove', seek);
                    document.removeEventListener('mousemove', seek);
                    document.removeEventListener('touchend', endSeek);
                    document.removeEventListener('mouseup', endSeek);
                }

                function updateWaveProgress(progress) {
                    const progressedCount = Math.floor((progress / 100) * waveBars.length);
                    waveBars.forEach((bar, index) => {
                        if (index < progressedCount) {
                            bar.classList.add('progressed');
                        } else {
                            bar.classList.remove('progressed');
                        }
                    });
                }

                function formatTime(seconds) {
                    const m = Math.floor(seconds / 60);
                    const s = Math.floor(seconds % 60);
                    return `${m}:${s < 10 ? '0' : ''}${s}`;
                }
            });
        }

        // === REPLY PREVIEW COPIÉ DE LA VERSION FONCTIONNELLE ===
        function renderReplyPreview(quoted) {
            if (quoted.startsWith(PUBLIC_URL)) {
                const filename = quoted.split('/').pop();
                const ext = filename.split('.').pop().toLowerCase();
                let preview = '';
                if (['jpeg','jpg','gif','png','heic','webp','avif','bmp','tiff','svg'].includes(ext)) {
                    preview = `<img src="${quoted}" class="reply-preview-media">`;
                } else if (['mp4','mov','avi','mkv','hevc','webm','ogv','3gp'].includes(ext)) {
                    preview = `<video src="${quoted}" class="reply-preview-media" muted></video>`;
                } else if (['mp3','wav','ogg','aac','m4a','flac'].includes(ext)) {
                    preview = `<i class="fa-solid fa-microphone reply-preview-icon"></i>`;
                } else {
                    preview = `<i class="fa-solid fa-file reply-preview-icon"></i>`;
                }
                return preview;
            } else {
                const lines = quoted.split('\n');
                const displayText = lines[0] + (lines.length > 1 ? '…' : '');
                return displayText;
            }
        }

        // === GESTION D'ERREUR D'ENVOI (pour voir pourquoi ça échoue) ===
        async function postData(content) {
            try {
                const res = await fetch(`${API}/send`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        sender_tfid: user.tfid,
                        receiver_tfid: activePeer.tfid,
                        message: content
                    })
                });
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(errorText || 'Erreur serveur inconnue');
                }
            } catch(e) {
                console.error("Envoi échoué:", e);
                alert("Impossible d'envoyer le message : " + e.message);
            }
        }

        // Dans sendMessage et uploadFile, utiliser postData(content) au lieu de fetch direct

        // === HEADER HEIGHT DYNAMIQUE ===
        function updateHeaderHeight() {
            const header = document.querySelector('.ios-header');
            if (header) {
                const height = header.offsetHeight + parseFloat(getComputedStyle(document.documentElement).getPropertyValue('padding-top') || 0);
                document.documentElement.style.setProperty('--header-height', `${height}px`);
            }
        }

        window.addEventListener('load', updateHeaderHeight);
        window.addEventListener('resize', updateHeaderHeight);

        // === GESTION CLAVIER (input-area monte) ===
        let fullHeight = window.innerHeight;
        window.addEventListener('resize', () => {
            const newHeight = window.innerHeight;
            const inputArea = document.querySelector('.input-area');
            if (newHeight < fullHeight) {
                const keyboardHeight = fullHeight - newHeight;
                inputArea.style.transform = `translateY(-${keyboardHeight}px)`;
            } else {
                inputArea.style.transform = '';
                fullHeight = newHeight;
            }
            updateHeaderHeight();
        });

        // Le reste du code JS reste identique à votre première version
        // (loadContacts, openChat, syncChatSilently, sendMessage, handleFileSelect, etc.)
        // Mais dans sendMessage et uploadFile → appel à postData(content)

        // Exemple pour sendMessage :
        async function sendMessage() {
            const input = document.getElementById('msg-input');
            let text = input.value.trim();
            if(!text || !activePeer) return;
            if (replyingTo) {
                text = REPLY_START + replyingTo.id + REPLY_END + replyingTo.sender + REPLY_END + replyingTo.quoted + REPLY_END + '\n\n' + text;
                replyingTo = null;
                cancelReply();
            }
            input.value = "";
            input.style.height = 'auto';
            await postData(text);
            syncChatSilently();
        }

        // Exemple pour uploadFile (fin) :
        // ...
        const url = await uploadRes.text();
        let content = url;
        if (replyingTo) {
            content = REPLY_START + replyingTo.id + REPLY_END + replyingTo.sender + REPLY_END + replyingTo.quoted + REPLY_END + '\n\n' + url;
            replyingTo = null;
            cancelReply();
        }
        await postData(content);
        syncChatSilently();

    </script>
</body>
</html>
