export default {
  async fetch(request) {
    const url = new URL(request.url);

    if (url.pathname === "/" || url.pathname === "") {
      const html = `
        <!DOCTYPE html>
        <html lang="fr">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Adam_D’H7 | Url</title> 
          <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#000000" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Adam_D'H7 | Url" />
  <link rel="apple-touch-icon" href="https://res.cloudinary.com/dckwrqrur/image/upload/v1757205404/tf-stream-url/Screenshot_20250906_202106_Chrome_go9vhu.png" />
          <style>
            body {
              background-color: #000000; 
              margin: 0;
              height: 100vh;
              display: flex;
              align-items: center;
              justify-content: center;
              font-family: 'Inter', -apple-system, sans-serif;
              color: #ffffff;
            }

            .glass-card {
              background: rgba(30, 30, 30, 0.6); 
              backdrop-filter: blur(15px); 
              -webkit-backdrop-filter: blur(15px);
              border: 1px solid rgba(255, 255, 255, 0.1);
              padding: 50px 30px;
              border-radius: 24px;
              text-align: center;
              box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
              max-width: 350px;
              width: 90%;
            }

            h1 {
              font-size: 2.5rem;
              margin: 0;
              letter-spacing: -1px;
              color: #ffffff; 
              font-weight: 800;
            }

            p {
              color: #888888; 
              font-size: 0.9rem;
              margin-top: 10px;
              text-transform: uppercase;
              letter-spacing: 2px;
            }

            .status-dot {
              height: 8px;
              width: 8px;
              background-color: #ffffff;
              border-radius: 50%;
              display: inline-block;
              margin-right: 5px;
              box-shadow: 0 0 10px #ffffff;
            }

            .status-text {
              font-size: 0.75rem;
              color: #ffffff;
              opacity: 0.6;
              margin-top: 20px;
            }
          </style>
        </head>
        <body>
          <div class="glass-card">
            <h1>Adam_D’H7</h1>
            <p>URL</p>
            <div class="status-text">
              <span class="status-dot"></span> It's me Adam_D'H7
            </div>
          </div>
        </body>
        </html>
      `;

      return new Response(html, {
        headers: { "content-type": "text/html;charset=UTF-8" },
      });
    }

    let pathname = url.pathname;
    if (pathname.startsWith('/v/')) {
      pathname = pathname.slice(3); // Remove '/v/' prefix
    } else {
      // Optional: Redirect old .mp4 links to new format or handle gracefully
      return new Response('Invalid path', { status: 404 });
    }

    const filename = pathname + '.mp4'; // Append .mp4 for the internal source
    const titleParts = pathname.split('-').slice(1).join('-').replace(/_/g, ' ');
    const pageTitle = titleParts || 'Custom Player';

    const targetUrl = "https://pub-6801bec6f6414c08995c6708f70f99c2.r2.dev/" + filename;
    
    const playerHtml = `
<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${pageTitle}</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#000000" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="${pageTitle}" />
<link rel="apple-touch-icon" href="https://res.cloudinary.com/dckwrqrur/image/upload/v1757205404/tf-stream-url/Screenshot_20250906_202106_Chrome_go9vhu.png" />
<style>
  :root{
    --bg:transparent;
    --muted:#9aa0a6;
    --accent:#fff;
    --seek-height:8px;
    --box-bg: rgba(255,255,255,0.02);
    --box-border: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;padding:0;background:var(--bg);color:var(--accent);font-family:Inter,system-ui,Arial,sans-serif}
  .wrap, .video-card, .controls-wrap, .inside-mini-controls, .menu-overlay, .lang-overlay { user-select:none; -webkit-user-select:none; -ms-user-select:none; -moz-user-select:none; }

  .wrap{width:100%;height:100%;margin:0;padding:0;}

  .video-card{position:relative;border-radius:0;overflow:hidden;background:#000;aspect-ratio:16/9;width:100%;height:100%;touch-action:none}
  video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:1;background:#000;transition:filter .08s linear}
  video.contain{ object-fit:contain; background:#000; }

  .controls-wrap{position:absolute;left:12px;right:12px;bottom:12px;pointer-events:none;z-index:12;transition:opacity .18s ease}
  .time-row{display:flex;align-items:center;gap:12px;padding:8px 12px;color:var(--muted);font-size:14px;justify-content:center}
  .time{width:82px;text-align:center;font-variant-numeric:tabular-nums}
  .progress{flex:1;max-width:820px;display:flex;align-items:center}
  .seek{position:relative;height:var(--seek-height);width:100%;border-radius:999px;cursor:pointer;background:repeating-linear-gradient(90deg, rgba(255,255,255,0.06) 0 2px, rgba(255,255,255,0) 2px 12px);}
  .fill{position:absolute;left:0;top:0;height:100%;width:0%;border-radius:999px;background:linear-gradient(90deg, rgba(255,255,255,0.95), rgba(255,255,255,0.55));}
  .thumb{position:absolute;top:50%;transform:translate(-50%,-50%);width:18px;height:18px;border-radius:50%;background:#0b0b0b;border:2px solid var(--accent);box-shadow:none;pointer-events:auto;touch-action:none}

  .controls-hidden{opacity:0;pointer-events:none}
  .controls-visible{opacity:1;pointer-events:auto}

  .inside-mini-controls{
    position:absolute;
    left:12px;
    right:12px;
    top:50%;
    transform:translateY(-50%);
    z-index:13;
    display:flex;
    justify-content:center;
    gap:14px;
    pointer-events:auto;
    transition:opacity .18s ease;
  }
  .inside-hidden{opacity:0;pointer-events:none}
  .inside-visible{opacity:1;pointer-events:auto}

  .inside-item{
    min-width:86px;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:8px;
    border-radius:10px;
    background:var(--box-bg);
    border:1px solid var(--box-border);
  }
  .inside-item .mini-btn{
    width:100%;
    height:44px;
    border-radius:8px;
    border:none;
    background:transparent;
    color:var(--accent);
    font-weight:700;
    font-size:15px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    -webkit-tap-highlight-color: transparent;
  }
  .inside-item .mini-btn:active{transform:translateY(1px)}
  @media (orientation:landscape) { .inside-item{min-width:110px;padding:10px} }

  .landscape-btn{margin-left:8px;border:none;background:transparent;color:var(--muted);font-size:18px;cursor:pointer}
  .landscape-btn:hover{color:var(--accent)}

  .menu-dots{margin-left:6px;border:none;background:transparent;color:var(--muted);font-size:18px;cursor:pointer;display:none;padding:6px;border-radius:8px}
  .video-card.landscape-mode .menu-dots{ display:inline-block; }
  @media (orientation:landscape) { .menu-dots { display:inline-block; } }
  .menu-dots:hover{color:var(--accent);background:rgba(255,255,255,0.02)}

  .swipe-indicator{
    position:absolute;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    min-width:140px;
    padding:10px 14px;
    border-radius:10px;
    background:rgba(0,0,0,0.75);
    color:var(--accent);
    display:flex;
    align-items:center;
    gap:10px;
    justify-content:center;
    z-index:20;
    pointer-events:none;
    opacity:0;
    transition:opacity .12s ease;
    font-weight:700;
    font-size:15px;
  }
  .swipe-indicator.show{opacity:1}
  .swipe-icon{width:22px;height:22px;flex:0 0 22px}
  .swipe-value{min-width:48px;text-align:right;font-variant-numeric:tabular-nums}

  .error{position:absolute;left:12px;right:12px;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.6);padding:16px;border-radius:10px;color:#ff9b9b;display:none;text-align:center;z-index:20}
  .error a{color:#fff;text-decoration:underline}

  .menu-overlay, .lang-overlay {
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:99999;
    pointer-events:auto;
    opacity:0;
    visibility:hidden;
    transition:opacity .14s ease, visibility .14s;
  }
  .menu-overlay.show, .lang-overlay.show { opacity:1; visibility:visible; }
  .menu-backdrop, .lang-backdrop { position:absolute; inset:0; z-index:99990; background:rgba(0,0,0,0.5); } 
  .menu-sheet, .lang-sheet {
    position:relative;
    z-index:99999;
    min-width:280px;
    max-width:92%;
    border-radius:12px;
    background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
    border:1px solid rgba(255,255,255,0.04);
    padding:16px;
    color:var(--accent);
    box-shadow: 0 10px 30px rgba(0,0,0,0.6);
  }
  .menu-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .back-btn{background:transparent;border:none;color:var(--muted);font-size:16px;display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px;border-radius:8px}
  .back-btn:hover{color:var(--accent);background:rgba(255,255,255,0.02)}
  .close-btn{margin-left:auto;background:transparent;border:none;color:var(--muted);font-size:18px;cursor:pointer;padding:6px;border-radius:8px}
  .close-btn:hover{color:var(--accent);background:rgba(255,255,255,0.02)}

  .menu-list{display:flex;flex-direction:column;gap:8px}
  .menu-item{padding:12px;border-radius:10px;background:rgba(255,255,255,0.01);cursor:pointer;border:1px solid rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:space-between}
  .menu-item:hover{background:rgba(255,255,255,0.03)}
  .menu-item strong{font-weight:700}

  .lang-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .lang-item{padding:12px;border-radius:10px;background:rgba(255,255,255,0.01);cursor:pointer;border:1px solid rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:space-between}
  .lang-item:hover{background:rgba(255,255,255,0.03)}
  .bold{font-weight:800}
</style>
</head>
<body>
  <div class="wrap">
    <div class="video-card" id="card">
      <video id="video" preload="auto" playsinline crossorigin="anonymous">
        <source src="${targetUrl}" type="video/mp4">
        Votre navigateur ne supporte pas la vidéo HTML5.
      </video>

      <div class="inside-mini-controls inside-visible" id="insideMini">
        <div class="inside-item"><button class="mini-btn" id="insideBack">-10</button></div>
        <div class="inside-item"><button class="mini-btn" id="insidePlay">❚❚</button></div>
        <div class="inside-item"><button class="mini-btn" id="insideForward">+10</button></div>
      </div>

      <div class="controls-wrap controls-visible" id="controlsWrap">
        <div class="time-row" id="timeRow">
          <div class="time" id="current">0:00</div>
          <div class="progress">
            <div class="seek" id="seekBar" tabindex="0" role="slider" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
              <div class="fill" id="fill"></div>
              <div class="thumb" id="thumb" aria-hidden="true"></div>
            </div>
          </div>
          <div class="time" id="duration">0:00</div>
          <button class="landscape-btn" id="landscapeBtn" title="Basculer paysage">⛶</button>
          <button class="menu-dots" id="menuBtn" title="Menu">⋯</button>
        </div>
      </div>

      <div class="swipe-indicator" id="swipeIndicator" aria-hidden="true">
        <div class="swipe-icon" id="swipeIcon"></div>
        <div class="swipe-value" id="swipeValue">0%</div>
      </div>

      <div class="error" id="errorBox">Impossible de lire la vidéo. <span id="errTxt"></span></div>
    </div>
  </div>

  <div class="menu-overlay" id="menuOverlay" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="menu-backdrop" id="menuBackdrop"></div>
    <div class="menu-sheet" role="document" aria-label="Menu player">
      <div class="menu-header">
        <button class="back-btn" id="menuBackBtn" title="Retour" aria-label="Retour" style="display:none">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="color:var(--muted)"><path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Retour
        </button>
        <strong style="font-weight:700">Options</strong>
        <button class="close-btn" id="menuCloseBtn" title="Fermer" aria-label="Fermer">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="color:var(--muted)"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>

      <div class="menu-list" id="menuList">
        <div class="menu-item" id="menuLang" role="button" tabindex="0">
          <span>Langue</span>
          <span aria-hidden="true">›</span>
        </div>
        <div class="menu-item" id="menuPip" role="button" tabindex="0">
          <span>Mode PIP</span>
          <span id="pipStatus" style="opacity:.8;font-size:13px">Activer</span>
        </div>
      </div>
    </div>
  </div>

  <div class="lang-overlay" id="langOverlay" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="lang-backdrop" id="langBackdrop"></div>
    <div class="lang-sheet" role="document" aria-label="Langue settings">
      <div class="menu-header">
        <button class="back-btn" id="langBackBtn" title="Retour" aria-label="Retour">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="color:var(--muted)"><path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Retour
        </button>
        <strong style="font-weight:700">Langue</strong>
        <button class="close-btn" id="langCloseBtn" title="Fermer" aria-label="Fermer">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="color:var(--muted)"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>

      <div class="lang-list">
        <div class="lang-item"><strong class="bold">Audio</strong><span style="opacity:.8">Français</span></div>
        <div class="lang-item"><strong class="bold">Sous-titre</strong><span style="opacity:.8">Français</span></div>
      </div>
    </div>
  </div>

<script>
(function(){
  const card = document.getElementById('card');
  const video = document.getElementById('video');

  const insidePlay = document.getElementById('insidePlay');
  const insideForward = document.getElementById('insideForward');
  const insideBack = document.getElementById('insideBack');

  const seekBar = document.getElementById('seekBar');
  const fill = document.getElementById('fill');
  const thumb = document.getElementById('thumb');
  const currentEl = document.getElementById('current');
  const durationEl = document.getElementById('duration');
  const landscapeBtn = document.getElementById('landscapeBtn');
  const menuBtn = document.getElementById('menuBtn');

  const controlsWrap = document.getElementById('controlsWrap');
  const insideMini = document.getElementById('insideMini');

  const swipeIndicator = document.getElementById('swipeIndicator');
  const swipeIcon = document.getElementById('swipeIcon');
  const swipeValue = document.getElementById('swipeValue');

  const menuOverlay = document.getElementById('menuOverlay');
  const menuBackdrop = document.getElementById('menuBackdrop');
  const menuCloseBtn = document.getElementById('menuCloseBtn');
  const menuBackBtn = document.getElementById('menuBackBtn');
  const menuLang = document.getElementById('menuLang');
  const menuPip = document.getElementById('menuPip');
  const pipStatus = document.getElementById('pipStatus');

  const langOverlay = document.getElementById('langOverlay');
  const langBackdrop = document.getElementById('langBackdrop');
  const langCloseBtn = document.getElementById('langCloseBtn');
  const langBackBtn = document.getElementById('langBackBtn');

  const svgBrightness = \`<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="22" height="22"><path d="M12 4V2M12 22v-2M4.93 4.93L3.51 3.51M20.49 20.49l-1.42-1.42M4 12H2M22 12h-2M4.93 19.07l-1.42 1.42M20.49 3.51l-1.42 1.42M12 8a4 4 0 100 8 4 4 0 000-8z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>\`;
  const svgVolume = \`<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="22" height="22"><path d="M11 5L6 9H2v6h4l5 4V5z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M19 9a5 5 0 010 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>\`;

  const cornerRatio = 0.20;

  function formatTime(sec){
    sec = Math.floor(sec) || 0;
    const h = Math.floor(sec/3600);
    const m = Math.floor((sec%3600)/60);
    const s = sec%60;
    if(h>0) return h + ":" + String(m).padStart(2,'0') + ":" + String(s).padStart(2,'0');
    return m + ":" + String(s).padStart(2,'0');
  }

  function isFullscreenCard(){ return document.fullscreenElement === card || document.webkitFullscreenElement === card; }
  function isDeviceLandscape(){ return window.innerWidth > window.innerHeight; }
  function allowOverlayNow(){ return isFullscreenCard() || isDeviceLandscape(); }

  async function tryAutoplay(){
    try { await video.play(); } catch(e){ try { video.muted = true; await video.play(); } catch(_){} }
    updatePlayIcon();
  }
  function updatePlayIcon(){ insidePlay.textContent = video.paused ? '▶︎' : '❚❚'; }
  async function togglePlay(){ try{ if(video.paused){ try{ video.muted = false; } catch(e){} await video.play(); } else video.pause(); } catch(e){ console.warn(e);} updatePlayIcon(); }
  insidePlay.addEventListener('click', (e)=>{ e.stopPropagation(); togglePlay(); });

  insideForward.addEventListener('click', (e)=>{ e.stopPropagation(); video.currentTime = Math.min(video.duration || 0, video.currentTime + 10); });
  insideBack.addEventListener('click', (e)=>{ e.stopPropagation(); video.currentTime = Math.max(0, video.currentTime - 10); });

  let scrubbing = false;
  let wasPlayingBeforeScrub = false;
  function timeFromClientX(clientX){
    const r = seekBar.getBoundingClientRect();
    let p = (clientX - r.left) / r.width;
    p = Math.max(0, Math.min(1, p));
    return (video.duration || 0) * p;
  }
  function startScrub(clientX){
    wasPlayingBeforeScrub = !video.paused;
    try { video.pause(); } catch(e){}
    scrubbing = true;
    const t = timeFromClientX(clientX);
    video.currentTime = t;
    currentEl.textContent = formatTime(t);
    const pct = (t / (video.duration || 1)) * 100;
    fill.style.width = pct + '%';
    thumb.style.left = pct + '%';
  }
  function moveScrub(clientX){
    if(!scrubbing) return;
    const t = timeFromClientX(clientX);
    video.currentTime = t;
    currentEl.textContent = formatTime(t);
    const pct = (t / (video.duration || 1)) * 100;
    fill.style.width = pct + '%';
    thumb.style.left = pct + '%';
  }
  function endScrub(){
    if(!scrubbing) return;
    scrubbing = false;
    if(wasPlayingBeforeScrub){
      try { video.play().catch(()=>{}); } catch(e){}
    }
  }

  seekBar.addEventListener('mousedown', (e)=>{ e.preventDefault(); e.stopPropagation(); startScrub(e.clientX); });
  window.addEventListener('mousemove', (e)=>{ moveScrub(e.clientX); });
  window.addEventListener('mouseup', (e)=>{ endScrub(); });

  seekBar.addEventListener('touchstart', (e)=>{ e.preventDefault(); e.stopPropagation(); startScrub(e.touches[0].clientX); }, {passive:false});
  window.addEventListener('touchmove', (e)=>{ if(e.touches && e.touches[0]) moveScrub(e.touches[0].clientX); }, {passive:false});
  window.addEventListener('touchend', (e)=>{ endScrub(); });

  thumb.addEventListener('pointerdown', (e)=>{ e.preventDefault(); e.stopPropagation(); startScrub(e.clientX); });
  window.addEventListener('pointermove', (e)=>{ if(e.pointerType) moveScrub(e.clientX); });
  window.addEventListener('pointerup', (e)=>{ endScrub(); });

  video.addEventListener('timeupdate', ()=> {
    currentEl.textContent = formatTime(video.currentTime);
    const pct = (video.currentTime / (video.duration || 1)) * 100;
    fill.style.width = pct + '%';
    thumb.style.left = pct + '%';
    seekBar.setAttribute('aria-valuenow', Math.floor(video.currentTime || 0));
  });
  video.addEventListener('loadedmetadata', ()=> {
    durationEl.textContent = formatTime(video.duration || 0);
    seekBar.setAttribute('aria-valuemax', Math.floor(video.duration || 0));
  });
  video.addEventListener('play', updatePlayIcon);
  video.addEventListener('pause', updatePlayIcon);

  function showAll(){ controlsWrap.classList.remove('controls-hidden'); controlsWrap.classList.add('controls-visible'); insideMini.classList.remove('inside-hidden'); insideMini.classList.add('inside-visible'); }
  function hideAll(){ controlsWrap.classList.remove('controls-visible'); controlsWrap.classList.add('controls-hidden'); insideMini.classList.remove('inside-visible'); insideMini.classList.add('inside-hidden'); }
  function toggleAll(){ const isVisible = controlsWrap.classList.contains('controls-visible') && insideMini.classList.contains('inside-visible'); if(isVisible) hideAll(); else showAll(); }

  function isOverControls(target){
    return !!(target && (target.closest && (target.closest('.controls-wrap') || target.closest('.inside-mini-controls') || target.closest('.inside-item') || target.closest('.seek'))));
  }

  card.addEventListener('click', (e)=>{
    if(isOverControls(e.target)) return;
    toggleAll();
  });

  [insidePlay, insideForward, insideBack, seekBar, landscapeBtn, menuBtn].forEach(el=>{
    if(!el) return;
    el.addEventListener('click', e=>e.stopPropagation());
    el.addEventListener('pointerdown', e=>e.stopPropagation());
    el.addEventListener('touchstart', e=>e.stopPropagation(), {passive:false});
  });

  async function enterLandscapeMode(){
    try{
      const el = card;
      if (el.requestFullscreen) await el.requestFullscreen();
      else if (el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
      if (screen.orientation && screen.orientation.lock) {
        try { await screen.orientation.lock('landscape'); } catch(_) {}
      }
    }catch(err){ console.warn('enterLandscape failed', err); }
    card.classList.add('landscape-mode');
    video.classList.add('contain');
    showAll();
  }
  async function exitLandscapeMode(){
    try{
      if (screen.orientation && screen.orientation.unlock) {
        try { screen.orientation.unlock(); } catch(_) {}
      }
      if (document.exitFullscreen) await document.exitFullscreen();
      else if (document.webkitExitFullscreen) await document.webkitExitFullscreen();
    }catch(err){ console.warn('exitLandscape failed', err); }
    card.classList.remove('landscape-mode');
    video.classList.remove('contain');
    showAll();
  }
  landscapeBtn.addEventListener('click', async (e)=>{ e.stopPropagation(); if(!isFullscreenCard()){ await enterLandscapeMode(); } else { await exitLandscapeMode(); } });

  document.addEventListener('fullscreenchange', ()=> {
    if(document.fullscreenElement === card) {
      card.classList.add('landscape-mode');
      video.classList.add('contain');
      showAll();
    } else {
      card.classList.remove('landscape-mode');
      video.classList.remove('contain');
      showAll();
      if(menuOverlay.parentNode === card) document.body.appendChild(menuOverlay);
      if(langOverlay.parentNode === card) document.body.appendChild(langOverlay);
    }
  });

  let gesture = null;
  let indicatorTimeout = null;
  function showSwipeIndicator(kind, percent){
    swipeIcon.innerHTML = (kind === 'brightness') ? svgBrightness : svgVolume;
    swipeValue.textContent = percent + '%';
    swipeIndicator.classList.add('show');
    if(indicatorTimeout) clearTimeout(indicatorTimeout);
    indicatorTimeout = setTimeout(()=>{ swipeIndicator.classList.remove('show'); }, 800);
  }
  function clamp(v,a=0,b=1){ return Math.max(a, Math.min(b, v)); }
  function startLandscapeGesture(clientX, clientY){
    if(!card.classList.contains('landscape-mode')) return;
    const rect = card.getBoundingClientRect();
    const relX = clientX - rect.left;
    const leftLimit = rect.width * cornerRatio;
    const rightLimit = rect.width * (1 - cornerRatio);
    if(relX <= leftLimit){
      const styleFilter = getComputedStyle(video).filter || '';
      const match = styleFilter.match(/brightness\\(([^)]+)\\)/);
      const initial = match ? parseFloat(match[1]) : 1;
      gesture = { type:'brightness', startY:clientY, initialValue: isNaN(initial) ? 1 : initial };
      showSwipeIndicator('brightness', Math.round(gesture.initialValue * 100));
    } else if(relX >= rightLimit){
      gesture = { type:'volume', startY:clientY, initialValue: video.volume };
      showSwipeIndicator('volume', Math.round(gesture.initialValue * 100));
    } else { gesture = null; }
  }
  function moveLandscapeGesture(clientY){
    if(!gesture) return;
    const rect = card.getBoundingClientRect();
    const delta = (gesture.startY - clientY);
    const pct = delta / rect.height;
    let newVal = gesture.initialValue + pct;
    newVal = clamp(newVal, 0, 1);
    if(gesture.type === 'brightness'){
      const applied = Math.max(0.05, newVal);
      video.style.filter = \`brightness(\${applied})\`;
      showSwipeIndicator('brightness', Math.round(applied * 100));
    } else {
      video.volume = newVal;
      showSwipeIndicator('volume', Math.round(newVal * 100));
    }
  }
  function endLandscapeGesture(){
    if(!gesture) return;
    gesture = null;
    if(indicatorTimeout) clearTimeout(indicatorTimeout);
    indicatorTimeout = setTimeout(()=>{ swipeIndicator.classList.remove('show'); }, 600);
  }
  card.addEventListener('touchstart', (e)=>{ if(!card.classList.contains('landscape-mode')) return; const t = e.touches[0]; startLandscapeGesture(t.clientX, t.clientY); }, {passive:false});
  card.addEventListener('touchmove', (e)=>{ if(!card.classList.contains('landscape-mode')) return; const t = e.touches[0]; moveLandscapeGesture(t.clientY); }, {passive:false});
  card.addEventListener('touchend', ()=>{ if(!card.classList.contains('landscape-mode')) return; endLandscapeGesture(); });

  const sourceUrl = video.querySelector('source')?.src || '';
  video.addEventListener('error', async (e)=>{
    try {
      const r = await fetch(sourceUrl, { method: 'HEAD', mode: 'cors' });
      if(!r.ok) showError('Le serveur répond ' + r.status + '.');
    } catch(fetchErr){
      console.error('HEAD failed', fetchErr);
      showError('Probable CORS (Access-Control-Allow-Origin absent). Ouvri console pour détails.');
    }
  });
  function showError(msg){ const errTxt = document.getElementById('errTxt'); if(errTxt) errTxt.textContent = msg; const eb = document.getElementById('errorBox'); if(eb) eb.style.display='block'; }

  let menuWasOpenBeforeLang = false;

  function placeOverlayInsideCard(overlay){
    if(overlay.parentNode !== card) card.appendChild(overlay);
    overlay.style.position = 'absolute';
    overlay.style.inset = '0';
    overlay.style.zIndex = '99999';
  }
  function placeOverlayBackToBody(overlay){
    if(overlay.parentNode !== document.body) document.body.appendChild(overlay);
    overlay.style.position = 'fixed';
    overlay.style.inset = '0';
    overlay.style.zIndex = '99999';
  }

  function openMenuOverlay(){
    if(!allowOverlayNow()) return;         
    placeOverlayInsideCard(menuOverlay);
    menuOverlay.classList.add('show');
    menuOverlay.setAttribute('aria-hidden','false');
    langOverlay.classList.remove('show');
    langOverlay.setAttribute('aria-hidden','true');
    hideAll();
  }
  function closeMenuOverlay(){
    menuOverlay.classList.remove('show');
    menuOverlay.setAttribute('aria-hidden','true');
    showAll();
    if(!allowOverlayNow()) placeOverlayBackToBody(menuOverlay);
  }

  function openLangOverlay(){
    if(!allowOverlayNow()) return;
    menuWasOpenBeforeLang = menuOverlay.classList.contains('show');
    placeOverlayInsideCard(langOverlay);
    menuOverlay.classList.remove('show');
    menuOverlay.setAttribute('aria-hidden','true');
    langOverlay.classList.add('show');
    langOverlay.setAttribute('aria-hidden','false');
    hideAll();
  }
  function closeLangOverlay(){
    langOverlay.classList.remove('show');
    langOverlay.setAttribute('aria-hidden','true');
    if(menuWasOpenBeforeLang){
      menuOverlay.classList.add('show');
      menuOverlay.setAttribute('aria-hidden','false');
      menuWasOpenBeforeLang = false;
    } else {
      showAll();
    }
    if(!allowOverlayNow()) placeOverlayBackToBody(langOverlay);
  }

  menuBtn.addEventListener('click', (e)=>{
    e.stopPropagation();
    openMenuOverlay();
  });

  if(menuCloseBtn) menuCloseBtn.addEventListener('click', (e)=>{ e.stopPropagation(); closeMenuOverlay(); });
  if(menuBackdrop) menuBackdrop.addEventListener('click', ()=>{ closeMenuOverlay(); });
  if(langCloseBtn) langCloseBtn.addEventListener('click', (e)=>{ e.stopPropagation(); closeLangOverlay(); });
  if(langBackdrop) langBackdrop.addEventListener('click', ()=>{ closeLangOverlay(); });

  if(menuLang) menuLang.addEventListener('click', (e)=>{ e.stopPropagation(); openLangOverlay(); });
  if(menuPip) menuPip.addEventListener('click', async (e)=>{
    e.stopPropagation();
    try {
      if(document.pictureInPictureElement) {
        await document.exitPictureInPicture();
        pipStatus.textContent = 'Activer';
      } else {
        try { await video.play(); } catch(_){}
        if (video.requestPictureInPicture) {
          await video.requestPictureInPicture();
          pipStatus.textContent = 'Désactiver';
        } else {
          if (video.webkitSetPresentationMode) {
            try { video.webkitSetPresentationMode('picture-in-picture'); pipStatus.textContent = 'Désactiver'; }
            catch(err){ console.warn('webkit PIP failed', err); alert('PiP non supporté par ce navigateur'); }
          } else {
            alert('Picture-in-Picture non supporté sur ce navigateur.');
          }
        }
      }
    } catch(err){
      console.warn('PiP failed', err);
      pipStatus.textContent = 'Erreur';
      setTimeout(()=>{ pipStatus.textContent = 'Activer'; }, 1400);
    } finally {
      setTimeout(()=> { if(document.pictureInPictureElement) closeMenuOverlay(); }, 300);
    }
  });

  if(langBackBtn) langBackBtn.addEventListener('click', (e)=>{ e.stopPropagation(); closeLangOverlay(); });

  window.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){
      if(langOverlay.classList.contains('show')) closeLangOverlay();
      else if(menuOverlay.classList.contains('show')) closeMenuOverlay();
    }
  });

  window.addEventListener('orientationchange', ()=>{
    if(!allowOverlayNow()){
      if(menuOverlay.classList.contains('show')) closeMenuOverlay();
      if(langOverlay.classList.contains('show')) closeLangOverlay();
      placeOverlayBackToBody(menuOverlay);
      placeOverlayBackToBody(langOverlay);
    }
  });
  window.addEventListener('resize', ()=>{
    if(!allowOverlayNow()){
      if(menuOverlay.classList.contains('show')) closeMenuOverlay();
      if(langOverlay.classList.contains('show')) closeLangOverlay();
      placeOverlayBackToBody(menuOverlay);
      placeOverlayBackToBody(langOverlay);
    }
  });

  tryAutoplay();
  showAll();

  window.__player = { video, openMenuOverlay, closeMenuOverlay, openLangOverlay, closeLangOverlay, allowOverlayNow };
})();
</script>
</body>
</html>
      `;

    return new Response(playerHtml, {
      headers: { "content-type": "text/html;charset=UTF-8" },
    });
  },
};
