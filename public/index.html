<!doctype html>
<html lang="ht">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TF-Stream</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#2563eb" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="TF-Stream-Url" />
  <link rel="apple-touch-icon" href="https://res.cloudinary.com/dckwrqrur/image/upload/v1755996395/tf-stream-url/tfstream-text-only_mo4wml.png" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Si backend la sou yon lòt domèn, mete li isit la: -->
  <!-- <meta name="api-base" content="https://api.mondomaine.com"> -->

  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; margin: 0; }
    .ad-layer { pointer-events: auto; z-index: 9999; } /* piblisite aktive */
    #mainUI { position: relative; z-index: 10001; }
    #ad-left, #ad-right { width: 90px; max-width: 120px; }
    #ad-top, #ad-bottom { height: 90px; }
    .ad-frame { display: block; }
    .ad-layer iframe, .ad-layer > div { opacity: 0.98; }
    .copied { color: #059669; font-weight: 600; }

    .file-name {
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: normal;
      word-break: break-word;
      cursor: pointer;
    }
    .file-name.expanded { -webkit-line-clamp: unset; overflow: visible; text-overflow: unset; white-space: normal; }
    .selected-row { display:flex; align-items:flex-start; gap:0.5rem; }
    .selected-row .meta { flex:1; min-width:0; }
    @media (max-width:420px) { .file-name { font-size: 13px; } .ad-layer { display:none; } }
  </style>
</head>
<body class="relative">
  <div id="mainUI" class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white w-full max-w-2xl rounded-3xl shadow-xl p-6 space-y-5">

      <h2 class="text-xl font-bold text-center text-gray-800">TF-Stream</h2>

      <input id="fileInput" type="file" accept="*/*" multiple class="block w-full text-sm text-gray-700 bg-gray-100 rounded-xl border border-gray-300 p-2 cursor-pointer" />

      <div id="selectedList" class="grid gap-2"></div>

      <div class="flex gap-2">
        <button id="uploadBtn" class="flex-1 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-xl transition">Upload tout</button>
        <button id="cancelAllBtn" class="w-32 bg-gray-200 text-gray-700 font-semibold py-2 rounded-xl hidden">Anile tout</button>
      </div>

      <div id="overallProgressWrap" class="mt-2 hidden">
        <div class="text-xs text-gray-600 mb-1">Pwogrè total</div>
        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
          <div id="overallProgressFill" style="width:0%" class="h-3 rounded-full transition-all bg-blue-500"></div>
        </div>
        <div class="flex justify-between items-center mt-2 text-xs">
          <div id="overallPct" class="font-mono text-sm">0%</div>
          <div id="overallInfo" class="text-gray-500 text-xs"></div>
        </div>
      </div>

      <div id="result" class="text-center text-sm text-gray-700"></div>

      <div id="previewAll" class="mt-4 space-y-4"></div>

    </div>
  </div>

  <!-- ad-layer placeholders -->
  <div id="ad-top" class="ad-layer fixed top-0 left-0 w-full flex justify-center items-start"></div>
  <div id="ad-left" class="ad-layer fixed top-1/4 left-0 h-1/2 flex items-center"></div>
  <div id="ad-right" class="ad-layer fixed top-1/4 right-0 h-1/2 flex items-center"></div>
  <div id="ad-bottom" class="ad-layer fixed bottom-0 left-0 w-full flex justify-center items-end"></div>

  <script>
    // API base detection (meta or same-origin)
    const metaApi = document.querySelector('meta[name="api-base"]');
    const API_BASE = (window.__API_BASE__ && String(window.__API_BASE__).trim()) || (metaApi ? metaApi.getAttribute('content') : '') || window.location.origin;
    const UPLOAD_ENDPOINT = new URL('/upload', API_BASE).toString();
    const PROGRESS_ENDPOINT = (id) => new URL(`/progress/${id}`, API_BASE).toString();

    // elements
    const fileInput = document.getElementById('fileInput');
    const selectedList = document.getElementById('selectedList');
    const uploadBtn = document.getElementById('uploadBtn');
    const cancelAllBtn = document.getElementById('cancelAllBtn');
    const result = document.getElementById('result');
    const overallProgressWrap = document.getElementById('overallProgressWrap');
    const overallProgressFill = document.getElementById('overallProgressFill');
    const overallPct = document.getElementById('overallPct');
    const overallInfo = document.getElementById('overallInfo');
    const previewAll = document.getElementById('previewAll');

    let filesArray = [];
    let xhrs = new Map();
    let uploading = false;

    function humanFileSize(bytes) {
      const thresh = 1024;
      if (Math.abs(bytes) < thresh) return bytes + ' B';
      const units = ['KB','MB','GB','TB','PB','EB','ZB','YB'];
      let u = -1;
      do { bytes /= thresh; ++u; } while(Math.abs(bytes) >= thresh && u < units.length - 1);
      return bytes.toFixed(1)+' '+units[u];
    }
    function escapeHtml(unsafe) { return String(unsafe).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#039;"); }

    function renderSelectedList() {
      selectedList.innerHTML = '';
      if (filesArray.length === 0) {
        selectedList.innerHTML = `<div class="text-xs text-gray-500 italic">Pa gen fichye chwazi.</div>`;
        return;
      }
      const grid = document.createElement('div'); grid.className = 'space-y-1';
      filesArray.forEach((file, idx) => {
        const row = document.createElement('div'); row.className = 'flex items-center justify-between gap-2 bg-gray-50 border border-gray-200 rounded-xl p-2 selected-row';
        const left = document.createElement('div'); left.className = 'flex items-start gap-2 meta';
        const icon = document.createElement('div'); icon.className = 'w-10 h-10 flex-shrink-0 rounded-md bg-gray-100 flex items-center justify-center text-xs text-gray-600'; icon.textContent = file.type && file.type.startsWith('video') ? 'VID' : 'FILE';
        const titleWrap = document.createElement('div'); titleWrap.style.minWidth = '0';
        const title = document.createElement('div'); title.className = 'file-name text-sm text-gray-800'; title.textContent = file.name; title.title = file.name; title.addEventListener('click', ()=> title.classList.toggle('expanded'));
        const sub = document.createElement('div'); sub.className = 'text-xs text-gray-500'; sub.textContent = `${humanFileSize(file.size)} • ${file.type || '—'}`;
        titleWrap.appendChild(title); titleWrap.appendChild(sub);
        left.appendChild(icon); left.appendChild(titleWrap);
        const right = document.createElement('div'); right.className = 'flex items-center gap-2';
        const removeBtn = document.createElement('button'); removeBtn.className = 'text-xs text-red-600 px-2 py-1 rounded-md bg-red-50 border border-red-100'; removeBtn.textContent = 'Retire';
        removeBtn.onclick = () => { if (uploading) return; filesArray.splice(idx,1); renderSelectedList(); };
        right.appendChild(removeBtn); row.appendChild(left); row.appendChild(right); grid.appendChild(row);
      });
      selectedList.appendChild(grid);
    }

    fileInput.addEventListener('change', (e) => {
      const list = Array.from(e.target.files || []);
      filesArray = filesArray.concat(list);
      renderSelectedList();
    });

    // Normalizes various formats backend may return into an absolute https URL we can use directly
    function normalizeReturnedUrl(raw) {
      if (!raw && raw !== 0) return '';
      try {
        raw = String(raw).trim();
      } catch (e) {
        return '';
      }

      // If it's JSON-looking string, try parse
      if ((raw.startsWith('{') || raw.startsWith('[')) && raw.includes('"')) {
        try {
          const parsed = JSON.parse(raw);
          // common nested forms
          if (typeof parsed === 'string') raw = parsed;
          else if (parsed.url) raw = parsed.url;
          else if (parsed.location) raw = parsed.location;
          else if (parsed.path) raw = parsed.path;
        } catch (e) { /* ignore */ }
      }

      // If param is an object (someone passed the whole response)
      if (typeof raw !== 'string') {
        try {
          if (raw && raw.url) raw = String(raw.url);
          else if (raw && raw.location) raw = String(raw.location);
          else raw = String(raw);
        } catch (e) { raw = String(raw); }
      }

      raw = raw.trim();
      // remove surrounding quotes
      raw = raw.replace(/^"+|"+$/g, '');

      // decode common encodings
      try { raw = decodeURIComponent(raw); } catch (e) {}

      // if starts with '//' add current protocol
      if (/^\/\//.test(raw)) {
        raw = window.location.protocol + raw;
      }

      // if starts with '/' -> resolve relative to API_BASE (so backend can emit "/key" and we map to correct public URL)
      if (/^\//.test(raw)) {
        try { raw = new URL(raw, API_BASE).toString(); } catch (e) { raw = window.location.origin + raw; }
        return raw;
      }

      // if it's already absolute http(s) -> ok
      if (/^https?:\/\//i.test(raw)) return raw;

      // if it looks like domain/path without protocol (ex: pub-...r2.dev/xxx.mp4) -> add https://
      if (/^[\w.-]+\.[a-z]{2,}\/.+/i.test(raw)) {
        return 'https://' + raw;
      }

      // if it's just a key or filename (no slash or no domain), resolve relative to API_BASE
      if (!raw.includes('/') || /^[A-Za-z0-9_\-]+\.[A-Za-z0-9]+$/.test(raw) || /^[A-Za-z0-9_\-]+$/.test(raw)) {
        try { return new URL('/' + raw.replace(/^\/+/, ''), API_BASE).toString(); } catch (e) { return window.location.origin + '/' + raw.replace(/^\/+/, ''); }
      }

      // fallback: try add https
      return /^.+$/.test(raw) ? ('https://' + raw) : '';
    }

    // helper to extract URL from any of the resolver results
    function extractUrlFromResult(res) {
      if (!res && res !== 0) return '';
      if (typeof res === 'string') return res;
      if (typeof res === 'object') {
        if (res.url) return res.url;
        if (res.location) return res.location;
        if (res.path) return res.path;
        if (res.files && Array.isArray(res.files) && res.files[0] && (res.files[0].url || res.files[0].location || res.files[0].path)) {
          return res.files[0].url || res.files[0].location || res.files[0].path;
        }
      }
      // if it's something else, stringify
      try { return String(res); } catch (e) { return ''; }
    }

    uploadBtn.addEventListener('click', async () => {
      if (filesArray.length === 0) { return alert('Tanpri chwazi omwen yon fichye anvan ou upload.'); }
      if (uploading) return;
      uploading = true;
      uploadBtn.disabled = true;
      cancelAllBtn.classList.remove('hidden');
      fileInput.disabled = true;
      result.textContent = 'Kòmanse upload...';

      overallProgressWrap.classList.remove('hidden');
      overallInfo.textContent = '';

      previewAll.innerHTML = '';
      xhrs.clear();

      const totalBytes = filesArray.reduce((s,f) => s + f.size, 0);
      const loadedBytes = new Array(filesArray.length).fill(0);

      const blocks = filesArray.map((file, i) => {
        const block = document.createElement('div');
        block.className = 'p-3 bg-white border border-gray-200 rounded-xl shadow-sm';
        block.innerHTML = `
          <div class="flex items-center justify-between">
            <div>
              <div class="font-semibold text-sm text-gray-800">${escapeHtml(file.name)}</div>
              <div class="text-xs text-gray-500">${humanFileSize(file.size)} • ${file.type || '—'}</div>
            </div>
            <div class="flex items-center gap-2">
              <button class="text-xs text-gray-600 px-2 py-1 rounded-md bg-gray-50 hidden file-cancel">Anile</button>
            </div>
          </div>
          <div class="mt-3">
            <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
              <div class="file-progress h-2 rounded-full transition-all bg-blue-500" style="width:0%"></div>
            </div>
            <div class="flex justify-between items-center mt-2 text-xs">
              <div class="file-pct font-mono text-sm">0%</div>
              <div class="file-info text-gray-500"></div>
            </div>
            <div class="mt-3 file-result"></div>
          </div>
        `;
        previewAll.appendChild(block);
        return {
          block,
          fileProgressFill: block.querySelector('.file-progress'),
          filePct: block.querySelector('.file-pct'),
          fileInfo: block.querySelector('.file-info'),
          fileCancelBtn: block.querySelector('.file-cancel'),
          fileResult: block.querySelector('.file-result')
        };
      });

      function updateOverall() {
        const sum = loadedBytes.reduce((a,b) => a + b, 0);
        const overallPercent = totalBytes ? Math.round((sum / totalBytes) * 100) : 0;
        overallProgressFill.style.width = overallPercent + '%';
        overallPct.textContent = overallPercent + '%';
        overallInfo.textContent = `${humanFileSize(sum)} / ${humanFileSize(totalBytes)}`;
      }

      const uploadPromises = filesArray.map((file, i) => {
        const ui = blocks[i];
        return uploadSingleFile(file, i, {
          onProgress: (loaded, total, speed, secsLeft) => {
            const percent = total ? Math.round((loaded/total)*100) : 0;
            if (ui.fileProgressFill) ui.fileProgressFill.style.width = percent + '%';
            if (ui.filePct) ui.filePct.textContent = percent + '%';
            if (ui.fileInfo) ui.fileInfo.textContent = `${humanFileSize(loaded)} / ${humanFileSize(total)} • ${Math.round(secsLeft)}s left`;
            loadedBytes[i] = loaded;
            updateOverall();
          },
          onXhrCreated: (xhr) => {
            xhrs.set(i, xhr);
            if (ui.fileCancelBtn) {
              ui.fileCancelBtn.classList.remove('hidden');
              ui.fileCancelBtn.onclick = () => { try { xhr.abort(); } catch(e){} };
            }
          }
        }).then((rawResult) => {
          // rawResult might be a string (url) or an object from SSE/XHR handler; extract and normalize
          const extracted = extractUrlFromResult(rawResult);
          const normalized = normalizeReturnedUrl(extracted);

          // if normalized empty, still show rawResult stringified
          const displayUrl = normalized || (extracted ? extracted : (typeof rawResult === 'string' ? rawResult : JSON.stringify(rawResult)));

          // success UI
          loadedBytes[i] = file.size;
          updateOverall();
          if (ui.fileProgressFill) ui.fileProgressFill.style.width = '100%';
          if (ui.filePct) ui.filePct.textContent = '100%';
          if (ui.fileInfo) ui.fileInfo.textContent = `${humanFileSize(file.size)} • Konplete`;

          const div = document.createElement('div');
          div.className = 'mt-2';
          const urlDisplay = `<div class="break-all text-blue-600 text-xs cursor-pointer file-url">${escapeHtml(displayUrl)}</div>`;
          div.innerHTML = urlDisplay;
          ui.fileResult.appendChild(div);

          const urlEl = ui.fileResult.querySelector('.file-url');
          urlEl.onclick = async () => {
            try {
              await navigator.clipboard.writeText(displayUrl);
              result.innerHTML = '<span class="copied">URL kopi nan clipboard</span>';
              setTimeout(()=> result.textContent = '', 2000);
            } catch (e) {
              result.textContent = 'Pa kapab kopiye: ' + e.message;
            }
          };

          // render preview if image/video/audio using normalized URL if available, else try displayUrl
          const previewSrc = normalized || displayUrl;
          const type = (file.type || '').toLowerCase();
          if (type.startsWith('image/')) {
            const img = document.createElement('img');
            img.src = previewSrc;
            img.className = 'mt-2 mx-auto rounded-lg shadow max-h-44';
            ui.fileResult.appendChild(img);
          } else if (type.startsWith('video/') || type.startsWith('audio/')) {
            const vid = document.createElement('video');
            vid.src = previewSrc;
            vid.controls = true;
            vid.className = 'mt-2 mx-auto rounded-lg shadow max-h-44';
            ui.fileResult.appendChild(vid);
          }

          return { status: 'fulfilled', url: displayUrl };
        }).catch(err => {
          if (err && err.isAbort) {
            if (ui.fileInfo) ui.fileInfo.textContent = '';
            if (ui.filePct) ui.filePct.textContent = '—';
            if (ui.fileProgressFill) ui.fileProgressFill.style.width = '0%';
            const errDiv = document.createElement('div');
            errDiv.className = 'text-xs text-red-600 mt-2';
            errDiv.textContent = 'Upload anile pa itilizatè';
            ui.fileResult.appendChild(errDiv);
            return { status: 'aborted' };
          } else {
            if (ui.fileInfo) ui.fileInfo.textContent = '';
            if (ui.filePct) ui.filePct.textContent = '—';
            if (ui.fileProgressFill) ui.fileProgressFill.style.width = '0%';
            const errDiv = document.createElement('div');
            errDiv.className = 'text-xs text-red-600 mt-2';
            errDiv.textContent = 'Erè upload: ' + (err && err.message ? err.message : String(err));
            ui.fileResult.appendChild(errDiv);
            return { status: 'rejected', reason: err };
          }
        });
      });

      const results = await Promise.allSettled(uploadPromises);

      uploading = false;
      uploadBtn.disabled = false;
      cancelAllBtn.classList.add('hidden');
      fileInput.disabled = false;

      const succeeded = results.filter(r => r.status === 'fulfilled' && r.value && r.value.status === 'fulfilled').length;
      const aborted = results.filter(r => r.status === 'fulfilled' && r.value && r.value.status === 'aborted').length;
      const failed = results.filter(r => r.status === 'fulfilled' && r.value && r.value.status === 'rejected').length;
      overallInfo.textContent = `Konplete: ${humanFileSize(loadedBytes.reduce((a,b)=>a+b,0))}`;
      result.textContent = `Fen: ${succeeded} siksè, ${failed} erè, ${aborted} anile.`;
    });

    cancelAllBtn.addEventListener('click', () => {
      for (const xhr of xhrs.values()) {
        try { xhr.abort(); } catch(e) {}
      }
      xhrs.clear();
      result.textContent = 'Anile tout uploads...';
    });

    // SSE-aware uploadSingleFile (kept same endpoints but using absolute API_BASE)
    function uploadSingleFile(file, index, { onProgress = ()=>{}, onXhrCreated = ()=>{} } = {}) {
      return new Promise((resolve, reject) => {
        const endpoint = UPLOAD_ENDPOINT;
        const uploadId = (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : `uid-${Date.now()}-${Math.floor(Math.random()*100000)}`;
        let serverActive = false;
        let doneBySSE = false;
        let lastServerLoaded = 0;
        let lastServerTotal = file.size || 0;
        let sseDoneResolve;
        const sseDonePromise = new Promise((r) => { sseDoneResolve = r; });

        const es = new EventSource(PROGRESS_ENDPOINT(uploadId));
        es.addEventListener('progress', (ev) => {
          try {
            const d = JSON.parse(ev.data);
            serverActive = true;
            lastServerLoaded = d.loaded || 0;
            lastServerTotal = d.total || lastServerTotal || 0;
            onProgress(lastServerLoaded, lastServerTotal, 0, 0);
          } catch (e) {}
        });
        es.addEventListener('done', (ev) => {
          try {
            const d = JSON.parse(ev.data);
            doneBySSE = true;
            try { es.close(); } catch (e) {}
            onProgress(d.total || lastServerTotal, d.total || lastServerTotal, 0, 0);
            // Resolve with object so caller can inspect d (we'll extract url later)
            sseDoneResolve({ url: d.url || d.location || d.path || '', data: d });
          } catch (e) {
            sseDoneResolve({ url: '' });
          }
        });
        es.addEventListener('error', () => { serverActive = false; });

        const xhr = new XMLHttpRequest();
        let startTime = Date.now();
        xhr.open('POST', endpoint);
        try {
          xhr.setRequestHeader('x-upload-id', uploadId);
          xhr.setRequestHeader('x-file-size', String(file.size));
          xhr.setRequestHeader('x-file-name', encodeURIComponent(file.name));
        } catch (e) {}

        xhr.upload.onprogress = (e) => {
          if (serverActive) return;
          if (e.lengthComputable) {
            const elapsed = (Date.now() - startTime) / 1000;
            const speed = e.loaded / Math.max(elapsed, 0.001);
            const remainingBytes = e.total - e.loaded;
            const secsLeft = Math.round(remainingBytes / Math.max(speed, 1));
            onProgress(e.loaded, e.total, speed, secsLeft);
          } else {
            onProgress(e.loaded || 0, file.size || 0, 0, 0);
          }
        };

        xhr.onload = async () => {
          try { xhrs.delete(index); } catch (e) {}
          if (doneBySSE) return;
          try {
            const timeoutMs = 12000;
            const race = Promise.race([ sseDonePromise, new Promise((r) => setTimeout(() => r(null), timeoutMs)) ]);
            const sseResult = await race;
            if (sseResult && sseResult.url !== undefined) {
              try { es.close(); } catch (e) {}
              // resolve with object to keep structured info
              return resolve(sseResult);
            }
          } catch (e) {}

          if (xhr.status >= 200 && xhr.status < 300) {
            try {
              const data = JSON.parse(xhr.responseText || '{}');
              // prefer top-level url, else files[0].url, else stringify
              const url = data.url || data.fileUrl || data.path || data.location || (data.files && data.files[0] && (data.files[0].url || data.files[0].location || data.files[0].path)) || '';
              try { es.close(); } catch (e) {}
              // return object shape for uniformity
              return resolve({ url, data });
            } catch (err) {
              try { es.close(); } catch (e) {}
              return resolve((xhr.responseText || '').trim() || '');
            }
          } else {
            try { es.close(); } catch (e) {}
            return reject(new Error('HTTP ' + xhr.status + ' — ' + xhr.responseText));
          }
        };

        xhr.onerror = () => {
          try { xhrs.delete(index); } catch (e) {}
          try { es.close(); } catch (e) {}
          reject(new Error('Erè rezo pandan upload'));
        };

        xhr.onabort = () => {
          try { xhrs.delete(index); } catch (e) {}
          try { es.close(); } catch (e) {}
          const err = new Error('Abòte pa itilizatè');
          err.isAbort = true;
          reject(err);
        };

        onXhrCreated(xhr);

        try {
          const fd = new FormData();
          fd.append('file', file);
          xhr.send(fd);
        } catch (err) {
          try { es.close(); } catch (e) {}
          reject(err);
        }
      });
    }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => { console.log('Service worker registered.', reg); })
          .catch(err => { console.warn('Service worker registration failed:', err); });
      });
    }
  </script>

  <!-- Piblikite yo rete menm jan ak orijinal -->
  <script async="async" data-cfasync="false" src="//pantherinvincible.com/831d752652add5a4318102e95e23728b/invoke.js"></script>
  <div id="container-831d752652add5a4318102e95e23728b" class="ad-layer fixed top-2 left-1"></div>
  <script type="text/javascript" src="//pantherinvincible.com/97/a6/20/97a620f293cd665277c661660533234e.js"></script>
  <script type="text/javascript" src="//pantherinvincible.com/8f/36/29/8f362929c71ab43f93c6d86c43889bfb.js"></script>
  <script type="text/javascript">
    atOptions = {
      'key' : 'a948baf246dd1ff24f0a6fcde286b31b',
      'format' : 'iframe',
      'height' : 300,
      'width' : 160,
      'params' : {}
    };
  </script>
  <script type="text/javascript" src="//pantherinvincible.com/a948baf246dd1ff24f0a6fcde286b31b/invoke.js"></script>

  <script src="pwa.js"></script>
</body>
  </html>
